# Phase 3 仕様書: URL監視機能

## 概要

macOSメニューバーアプリ「Nya」に、ブラウザのアクティブタブURL監視機能を追加する。

## 背景

Phase 2まででアプリ名（Twitter, YouTube等）による検知は完了。
しかし実際のユーザーはブラウザ経由でSNSを見ることが多い。
Chrome/Safariで開いているURLを監視し、ブロック対象サイトを検知できるようにする。

---

## ユーザーストーリー

1. ユーザーがNyaアプリを起動する
2. 設定画面でブロックしたいURLパターン（x.com, youtube.com等）を登録する
3. ユーザーがChromeまたはSafariでブロック対象サイトを開く
4. 猶予時間（例: 10秒）経過後、猫が鳴いて警告する
5. ユーザーがまだ見続けている場合、一定間隔（例: 15秒）で繰り返し鳴く
6. ユーザーが別のサイト/アプリに移動すると、鳴き止む

---

## 機能要件

### F1: URL取得機能

| 項目 | 内容 |
|------|------|
| 対象ブラウザ | Google Chrome, Safari |
| 取得対象 | アクティブタブのURL |
| 取得タイミング | ブラウザが前面の時、一定間隔でポーリング |

### F2: ブロックURLリスト管理

| 項目 | 内容 |
|------|------|
| 保存形式 | ドメイン文字列のリスト（例: "x.com", "twitter.com"） |
| 操作 | 追加、削除 |
| 永続化 | アプリ終了後も保持 |
| デフォルト値 | twitter.com, x.com, instagram.com, facebook.com, youtube.com, tiktok.com, reddit.com |

### F3: 警告ロジック

| 項目 | 内容 |
|------|------|
| 猶予時間 | ブロックURLを開いてからX秒後に発動（設定可能、デフォルト10秒） |
| 繰り返し間隔 | 発動後、まだ見続けている場合Y秒ごとに再発動（設定可能、デフォルト15秒） |
| 発動アクション | 猫の鳴き声を再生 |
| リセット条件 | 別のサイトに移動、または別のアプリに切り替え |

### F4: 設定画面

| 設定項目 | 型 | デフォルト値 | 範囲 |
|---------|-----|-------------|------|
| 音量 | Int | 70 | 0-100% |
| 猶予時間 | Int | 10 | 1-60秒 |
| 繰り返し間隔 | Int | 15 | 5-60秒 |
| ブロックURLリスト | [String] | 上記デフォルト | - |

---

## 画面設計

### メニューバーポップアップ（既存を拡張）

```
┌─────────────────────────────────┐
│ 🐱 Nya is watching...           │
│ ─────────────────────────────── │
│ Current: youtube.com      ← 新規│
│ Today: 3 distractions           │
│ ─────────────────────────────── │
│ Settings...               ← 新規│
│ Quit ⌘Q                         │
└─────────────────────────────────┘
```

### 設定画面（新規）

```
┌─────────────────────────────────────────┐
│ ⚙️ Nya Settings                         │
├─────────────────────────────────────────┤
│ 🔊 Volume              [====○---] 70%   │
│ ⏱️ Grace Period        [  10  ] sec     │
│ 🔁 Repeat Interval     [  15  ] sec     │
├─────────────────────────────────────────┤
│ 🚫 Blocked Domains                      │
│  ┌───────────────────────────────────┐  │
│  │ x.com                         [🗑] │  │
│  │ twitter.com                   [🗑] │  │
│  │ youtube.com                   [🗑] │  │
│  │ instagram.com                 [🗑] │  │
│  └───────────────────────────────────┘  │
│  [+ Add Domain]                         │
└─────────────────────────────────────────┘
```

---

## 非機能要件

### パフォーマンス

- ブラウザ前面時のポーリング間隔: 30秒（省電力重視）
- それ以外: 停止（ブラウザ以外はポーリングしない）
- 監視対象: front window（アクティブウィンドウ）のみ
- CPU使用率: 常駐時1%未満を目標

### 権限

- Apple Events（オートメーション）権限が必要
- 初回起動時にユーザーへ許可を求めるダイアログが表示される
- 権限拒否時はUIで設定画面への誘導を表示

---

## 制約事項

- App Sandbox環境では追加のentitlement設定が必要
- ブラウザが起動していない/ウィンドウがない場合はURL取得をスキップ
- Chromium系ブラウザ（Brave, Edge等）は Phase 3 では対象外（将来拡張）

---

## 用語定義

| 用語 | 定義 |
|------|------|
| ブロックURL | 警告対象となるドメイン |
| 猶予時間（Grace Period） | ブロックURLを開いてから警告発動までの時間 |
| 繰り返し間隔（Repeat Interval） | 警告発動後、次の警告までの時間 |
| distraction | ブロックURLへのアクセス1回をカウント |
